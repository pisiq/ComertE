using Hotel.Data;
using Hotel.Models;

namespace Hotel.Services
{
    public class CartService : ICartService
    {
        private readonly ICartRepository _cartRepository;
        private readonly IRoomRepository _productRepository;

        public CartService(ICartRepository cartRepository, IRoomRepository productRepository)
        {
            _cartRepository = cartRepository;
            _productRepository = productRepository;
        }

        public async Task<Cart?> GetOrCreateCartAsync(string userId)
        {
            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null)
            {
                cart = await _cartRepository.CreateCartAsync(userId);
            }
            return cart;
        }

        public async Task<bool> AddToCartAsync(string userId, int productId, DateTime checkInDate, DateTime checkOutDate, int quantity = 1)
        {
            if (quantity <= 0) return false;
            if (checkOutDate <= checkInDate) return false;

            var product = await _productRepository.GetByIdAsync(productId);
            if (product == null) return false;

            var cart = await GetOrCreateCartAsync(userId);
            if (cart == null) return false;

            var existingItem = await _cartRepository.GetCartItemAsync(cart.Id, productId);
            
            if (existingItem != null)
            {
                existingItem.Quantity += quantity;
                existingItem.CheckInDate = checkInDate;
                existingItem.CheckOutDate = checkOutDate;
                cart.LastModifiedDate = DateTime.Now;
                return await _cartRepository.UpdateCartItemAsync(existingItem);
            }
            else
            {
                var cartItem = new CartItem
                {
                    CartId = cart.Id,
                    ProductId = productId,
                    Quantity = quantity,
                    CheckInDate = checkInDate,
                    CheckOutDate = checkOutDate,
                    AddedDate = DateTime.Now
                };

                await _cartRepository.AddCartItemAsync(cartItem);
                cart.LastModifiedDate = DateTime.Now;
                return true;
            }
        }

        public async Task<bool> UpdateCartItemQuantityAsync(string userId, int cartItemId, int quantity)
        {
            if (quantity <= 0)
            {
                return await RemoveFromCartAsync(userId, cartItemId);
            }

            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return false;

            var cartItem = cart.CartItems.FirstOrDefault(ci => ci.Id == cartItemId);
            if (cartItem == null) return false;

            cartItem.Quantity = quantity;
            cart.LastModifiedDate = DateTime.Now;
            return await _cartRepository.UpdateCartItemAsync(cartItem);
        }

        public async Task<bool> UpdateCartItemDatesAsync(string userId, int cartItemId, DateTime checkInDate, DateTime checkOutDate)
        {
            if (checkOutDate <= checkInDate) return false;

            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return false;

            var cartItem = cart.CartItems.FirstOrDefault(ci => ci.Id == cartItemId);
            if (cartItem == null) return false;

            cartItem.CheckInDate = checkInDate;
            cartItem.CheckOutDate = checkOutDate;
            cart.LastModifiedDate = DateTime.Now;
            return await _cartRepository.UpdateCartItemAsync(cartItem);
        }

        public async Task<bool> RemoveFromCartAsync(string userId, int cartItemId)
        {
            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return false;

            cart.LastModifiedDate = DateTime.Now;
            return await _cartRepository.RemoveCartItemAsync(cartItemId);
        }

        public async Task<bool> ClearCartAsync(string userId)
        {
            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return false;

            return await _cartRepository.ClearCartAsync(cart.Id);
        }

        public async Task<decimal> GetCartTotalAsync(string userId)
        {
            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return 0;

            return cart.CartItems.Sum(ci => ci.Product.Price * ci.NumberOfNights);
        }

        public async Task<int> GetCartItemCountAsync(string userId)
        {
            return await _cartRepository.GetCartItemCountAsync(userId);
        }

        public async Task<List<CartItem>> GetCartItemsAsync(string userId)
        {
            var cart = await _cartRepository.GetCartByUserIdAsync(userId);
            if (cart == null) return new List<CartItem>();

            return cart.CartItems.ToList();
        }
    }
}
