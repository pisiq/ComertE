using Hotel.Data;
using Hotel.Models;
using Hotel.Models.Context;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace Hotel.Services
{
    public class RoomService : IRoomService
    {
        private readonly IRoomRepository _roomRepository;
        private readonly IWebHostEnvironment _environment;
        private readonly HotelContext _context;
        private readonly ILogger<RoomService> _logger;
        private const string PhotosDirectory = "room-photos";

        public RoomService(
            IRoomRepository roomRepository,
            IWebHostEnvironment environment,
            HotelContext context,
            ILogger<RoomService> logger)
        {
            _roomRepository = roomRepository;
            _environment = environment;
            _context = context;
            _logger = logger;
        }

        public async Task<IEnumerable<Room>> GetAllRoomsAsync()
        {
            return await _roomRepository.GetAllAsync();
        }

        public async Task<IEnumerable<Room>> GetAllRoomsWithDetailsAsync()
        {
            return await _roomRepository.GetAllWithDetailsAsync();
        }

        public async Task<Room?> GetRoomByIdAsync(int id)
        {
            return await _roomRepository.GetByIdAsync(id);
        }

        public async Task<Room?> GetRoomByIdWithDetailsAsync(int id)
        {
            return await _roomRepository.GetByIdWithDetailsAsync(id);
        }

        public async Task<int> AddRoomAsync(Room room, IFormFile? mainPhoto, List<IFormFile>? additionalPhotos)
        {
            try
            {
                _logger.LogInformation("Adding new room: {RoomType}", room.Type);

                // Upload main photo if provided
                if (mainPhoto != null)
                {
                    room.MainPhotoPath = await SavePhotoAsync(mainPhoto);
                }

                // Save the room first to get the ID
                await _roomRepository.AddAsync(room);
                _logger.LogInformation("Room {RoomType} saved with ID: {RoomId}", room.Type, room.Id);

                // Upload additional photos if provided
                if (additionalPhotos != null && additionalPhotos.Count > 0)
                {
                    await SaveAdditionalPhotosAsync(room, additionalPhotos);
                    _logger.LogInformation("Added {Count} additional photos to room {RoomId}", additionalPhotos.Count, room.Id);
                }

                return room.Id;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error adding room: {RoomType}", room?.Type);
                throw;
            }
        }

        public async Task<bool> UpdateRoomAsync(Room room, IFormFile? mainPhoto, List<IFormFile>? additionalPhotos)
        {
            try
            {
                _logger.LogInformation("Updating room ID: {RoomId}", room.Id);

                // Get the existing room to compare - use AsNoTracking to avoid tracking conflicts
                var existingRoom = await _context.Rooms
                    .AsNoTracking()
                    .Include(r => r.Photos)
                    .FirstOrDefaultAsync(r => r.Id == room.Id);
                    
                if (existingRoom == null)
                {
                    _logger.LogWarning("Room not found for update: {RoomId}", room.Id);
                    return false;
                }

                // Upload new main photo if provided
                if (mainPhoto != null)
                {
                    // Delete old photo if exists
                    DeletePhotoIfExists(existingRoom.MainPhotoPath);

                    // Save new photo
                    room.MainPhotoPath = await SavePhotoAsync(mainPhoto);
                    _logger.LogInformation("Updated main photo for room {RoomId}", room.Id);
                }
                else
                {
                    // Keep the existing main photo
                    room.MainPhotoPath = existingRoom.MainPhotoPath;
                }

                // Update the room entity
                await _roomRepository.UpdateAsync(room);
                _logger.LogInformation("Room {RoomId} updated successfully", room.Id);

                // Upload additional photos if provided
                if (additionalPhotos != null && additionalPhotos.Count > 0)
                {
                    foreach (var photo in additionalPhotos)
                    {
                        if (photo.Length > 10 * 1024 * 1024)
                            throw new InvalidOperationException($"Photo '{photo.FileName}' exceeds 10MB.");
                    }

                    await SaveAdditionalPhotosAsync(room, additionalPhotos);
                    _logger.LogInformation("Added {Count} new photos to room {RoomId}", additionalPhotos.Count, room.Id);
                }

                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating room ID: {RoomId}", room?.Id);
                throw; // Re-throw to let controller handle it
            }
        }

        public async Task<bool> DeleteRoomAsync(int id)
        {
            try
            {
                _logger.LogInformation("Attempting to delete room ID: {RoomId}", id);

                var room = await _roomRepository.GetByIdWithDetailsAsync(id);
                if (room == null)
                {
                    _logger.LogWarning("Room not found for deletion: {RoomId}", id);
                    return false;
                }

                // Get all booking items for this room
                var bookingItems = await _context.BookingItems
                    .Include(bi => bi.Booking)
                    .Where(bi => bi.RoomId == id)
                    .AsNoTracking()
                    .ToListAsync();

                if (bookingItems.Any())
                {
                    // Check for active bookings (Confirmed or Pending)
                    var activeBookings = bookingItems.Where(bi => 
                        bi.Booking.Status == BookingStatus.Confirmed || 
                        bi.Booking.Status == BookingStatus.Pending).ToList();

                    // If there are active bookings, prevent deletion
                    if (activeBookings.Any())
                    {
                        var activeCount = activeBookings.Count;
                        
                        _logger.LogWarning(
                            "Cannot delete room {RoomId} - has {Count} active booking(s)", 
                            id, activeCount);

                        throw new InvalidOperationException(
                            $"Cannot delete room. It has {activeCount} active booking(s) (Confirmed or Pending). " +
                            "Please cancel or complete these bookings first.");
                    }

                    // If we reach here, only cancelled or completed bookings exist
                    // Delete those booking items to allow room deletion
                    var inactiveBookingItems = bookingItems.Where(bi => 
                        bi.Booking.Status == BookingStatus.Cancelled || 
                        bi.Booking.Status == BookingStatus.Completed).ToList();

                    if (inactiveBookingItems.Any())
                    {
                        _logger.LogInformation(
                            "Deleting {Count} inactive booking items for room {RoomId}", 
                            inactiveBookingItems.Count, id);

                        // Delete the booking items from the database
                        foreach (var item in inactiveBookingItems)
                        {
                            var bookingItemToDelete = await _context.BookingItems.FindAsync(item.Id);
                            if (bookingItemToDelete != null)
                            {
                                _context.BookingItems.Remove(bookingItemToDelete);
                            }
                        }
                        
                        await _context.SaveChangesAsync();
                        
                        _logger.LogInformation(
                            "Deleted {Count} cancelled/completed booking items for room {RoomId}", 
                            inactiveBookingItems.Count, id);
                    }
                }

                // Delete all photos
                if (room.Photos != null && room.Photos.Any())
                {
                    foreach (var photo in room.Photos.ToList())
                    {
                        DeletePhotoIfExists(photo.FilePath);
                        await _roomRepository.DeletePhotoAsync(photo.Id);
                    }
                    _logger.LogInformation("Deleted {Count} photos from room {RoomId}", room.Photos.Count, id);
                }

                // Delete main photo if exists
                DeletePhotoIfExists(room.MainPhotoPath);

                // Delete the room
                await _roomRepository.DeleteAsync(id);
                _logger.LogInformation("Successfully deleted room ID: {RoomId}", id);
                return true;
            }
            catch (InvalidOperationException)
            {
                throw; // Re-throw business logic exceptions
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting room ID: {RoomId}", id);
                throw; // Re-throw to show the actual error
            }
        }

        public async Task<bool> UpdateRoomPhotoAsync(RoomPhoto photo, IFormFile? file)
        {
            try
            {
                if (file != null)
                {
                    // Delete old photo if exists
                    DeletePhotoIfExists(photo.FilePath);

                    // Save new photo
                    photo.FilePath = await SavePhotoAsync(file);
                }

                await _roomRepository.UpdatePhotoAsync(photo);
                _logger.LogInformation("Updated photo ID: {PhotoId}", photo.Id);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error updating photo ID: {PhotoId}", photo?.Id);
                return false;
            }
        }

        public async Task<bool> DeleteRoomPhotoAsync(int photoId)
        {
            try
            {
                _logger.LogInformation("Deleting photo ID: {PhotoId}", photoId);

                // Find the photo
                var allRooms = await _roomRepository.GetAllWithDetailsAsync();
                RoomPhoto? photo = null;

                foreach (var room in allRooms)
                {
                    photo = room.Photos?.FirstOrDefault(p => p.Id == photoId);
                    if (photo != null)
                    {
                        _logger.LogInformation("Found photo {PhotoId} in room {RoomId}", photoId, room.Id);
                        break;
                    }
                }

                if (photo == null)
                {
                    _logger.LogWarning("Photo not found: {PhotoId}", photoId);
                    return false;
                }

                // Delete the file
                DeletePhotoIfExists(photo.FilePath);

                // Delete from database
                await _roomRepository.DeletePhotoAsync(photoId);
                _logger.LogInformation("Successfully deleted photo ID: {PhotoId}", photoId);
                return true;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting photo ID: {PhotoId}", photoId);
                return false;
            }
        }

        private async Task<string> SavePhotoAsync(IFormFile file)
        {
            try
            {
                var uploadsFolder = Path.Combine(_environment.WebRootPath, PhotosDirectory);

                // Create directory if it doesn't exist
                if (!Directory.Exists(uploadsFolder))
                {
                    Directory.CreateDirectory(uploadsFolder);
                    _logger.LogInformation("Created photos directory: {Path}", uploadsFolder);
                }

                // Create unique filename
                var fileExtension = Path.GetExtension(file.FileName);
                var uniqueFileName = $"{Guid.NewGuid()}{fileExtension}";
                var filePath = Path.Combine(uploadsFolder, uniqueFileName);

                // Save the file
                using (var fileStream = new FileStream(filePath, FileMode.Create))
                {
                    await file.CopyToAsync(fileStream);
                }

                _logger.LogInformation("Saved photo: {FileName} as {UniqueFileName}", file.FileName, uniqueFileName);

                // Return relative path from wwwroot
                return $"/{PhotosDirectory}/{uniqueFileName}";
            }
            catch (UnauthorizedAccessException ex)
            {
                _logger.LogError(ex, "Permission denied when saving photo: {FileName}", file.FileName);
                throw new InvalidOperationException("Unable to save photo due to permission restrictions. Please check folder permissions.", ex);
            }
            catch (IOException ex)
            {
                _logger.LogError(ex, "IO error when saving photo: {FileName}", file.FileName);
                throw new InvalidOperationException("Unable to save photo due to file system error.", ex);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Unexpected error saving photo: {FileName}", file.FileName);
                throw;
            }
        }

        private async Task SaveAdditionalPhotosAsync(Room room, List<IFormFile> files)
        {
            // Get highest display order
            var startOrder = room.Photos != null && room.Photos.Any()
                ? room.Photos.Max(p => p.DisplayOrder) + 1
                : 1;

            for (int i = 0; i < files.Count; i++)
            {
                var filePath = await SavePhotoAsync(files[i]);

                var photo = new RoomPhoto
                {
                    RoomId = room.Id,
                    FilePath = filePath,
                    Caption = Path.GetFileNameWithoutExtension(files[i].FileName),
                    DisplayOrder = startOrder + i,
                    IsFeatured = (room.Photos == null || room.Photos.Count == 0) && i == 0
                };

                await _roomRepository.AddPhotoAsync(photo);
            }
        }

        private void DeletePhotoIfExists(string? photoPath)
        {
            if (string.IsNullOrEmpty(photoPath))
                return;

            try
            {
                // Convert URL path to file system path
                var filePath = Path.Combine(_environment.WebRootPath, photoPath.TrimStart('/'));

                if (File.Exists(filePath))
                {
                    File.Delete(filePath);
                    _logger.LogInformation("Deleted photo file: {FilePath}", filePath);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error deleting photo file: {PhotoPath}", photoPath);
            }
        }
    }
}